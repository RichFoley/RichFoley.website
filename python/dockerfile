FROM python:3.8.3 as base

ARG USERNAME=djangossh
ARG USERPASS=shhimworkinghere

# TODO: move this to dev build before production
RUN apt update && apt -y install openssh-server whois
RUN useradd -ms /bin/bash $USERNAME
RUN usermod --password $(echo "$USERPASS" | mkpasswd -s) $USERNAME
RUN apt purge -y whois && apt -y autoremove && apt -y autoclean && apt -y clean
USER $USERNAME
WORKDIR /home/$USERNAME
COPY entrypoint.sh entrypoint.sh
RUN chmod +x /entrypoint.sh
USER $USERNAME
RUN mkdir /home/$USERNAME/.ssh && touch /home/$USERNAME/.ssh/authorized_keys
USER root
VOLUME /home/$USERNAME/.ssh
VOLUME /etc/ssh
CMD ["/entrypoint.sh"]
# End of SSH

RUN mkdir /work/
WORKDIR /work/

COPY ./requirements.txt /work/requirements.txt
RUN pip install -r requirements.txt

#COPY ./python/src/ /work/
ENV PYTHONUNBUFFERED 1

FROM base as prod

CMD python manage.py runserver 0.0.0.0:8000